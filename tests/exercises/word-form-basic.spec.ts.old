import {expect, type Page, test} from '@playwright/test'
import {ROUTES} from '../fixtures/selectors'
import {EXERCISE_DATA, EXERCISE_STATUS, UI_TEXT} from '../fixtures/test-data'
import {ExerciseLibrary} from '../pages/ExerciseLibrary'
import {ExercisePage} from '../pages/ExercisePage'

const commonSetup = async (page: Page) => {
	const exerciseLibrary = new ExerciseLibrary(page)
	await exerciseLibrary.goto()
}

test.describe('Word Form Exercise - Loading', () => {
	test.beforeEach(commonSetup)

	test('should load exercise page correctly', async ({page}) => {
		const exerciseLibrary = new ExerciseLibrary(page)
		const exercisePage = new ExercisePage(page)

		await exerciseLibrary.startFirstExercise()

		await expect(page).toHaveURL(ROUTES.exerciseVerbsBe)
		await exercisePage.expectPageLoaded()
		await exercisePage.expectAutoAdvanceEnabled(true)
	})
})

test.describe('Word Form Exercise - Answer Handling', () => {
	test.beforeEach(commonSetup)

	test('should accept correct answers', async ({page}) => {
		const exerciseLibrary = new ExerciseLibrary(page)
		const exercisePage = new ExercisePage(page)

		await exerciseLibrary.startFirstExercise()

		// Answer first question correctly
		await exercisePage.submitAnswer(EXERCISE_DATA.verbsBe.correctAnswers[0])
		await exercisePage.expectCorrectFeedback()
		await exercisePage.waitForAutoAdvance()

		// Should advance to next question automatically
		await exercisePage.expectProgressText(UI_TEXT.progress.createPattern(2))
	})

	test('should handle incorrect answers', async ({page}) => {
		const exerciseLibrary = new ExerciseLibrary(page)
		const exercisePage = new ExercisePage(page)

		await exerciseLibrary.startFirstExercise()

		// Answer incorrectly
		await exercisePage.submitAnswer(EXERCISE_DATA.verbsBe.wrongAnswers[0])
		await exercisePage.expectIncorrectFeedback()
		await exercisePage.waitForAnswerProcessing()

		// Should require correction
		await exercisePage.expectInputStatus(EXERCISE_STATUS.requireCorrection)
	})
})

test.describe('Word Form Exercise - Tone Handling', () => {
	test.beforeEach(commonSetup)

	test('should handle tone-insensitive answers (currently requires tones)', async ({
		page
	}) => {
		const exerciseLibrary = new ExerciseLibrary(page)
		const exercisePage = new ExercisePage(page)

		await exerciseLibrary.startFirstExercise()

		// Answer without tones (currently not accepted - requires exact match)
		await exercisePage.submitAnswer(
			EXERCISE_DATA.verbsBe.alternativeAnswers.toneFree[0]
		)
		await exercisePage.expectIncorrectFeedback()
		await exercisePage.waitForAnswerProcessing()

		// Should require correction
		await exercisePage.expectInputStatus(EXERCISE_STATUS.requireCorrection)

		// Enter correct answer with tones
		await exercisePage.submitAnswer(EXERCISE_DATA.verbsBe.correctAnswers[0])
		await exercisePage.expectCorrectFeedback()
		await exercisePage.waitForAutoAdvance()

		// Should advance to next question
		await exercisePage.expectProgressText(UI_TEXT.progress.createPattern(2))
	})
})

test.describe('Word Form Exercise - Completion', () => {
	test.beforeEach(commonSetup)

	test('should complete full exercise sequence', async ({page}) => {
		const exerciseLibrary = new ExerciseLibrary(page)
		const exercisePage = new ExercisePage(page)

		await exerciseLibrary.startFirstExercise()

		// Answer all questions correctly
		await exercisePage.answerUntilCompletion(
			EXERCISE_DATA.verbsBe.correctAnswers
		)

		// Should show completion screen
		await exercisePage.expectExerciseCompleted()
	})
})

test.describe('Word Form Exercise - User Interactions', () => {
	test.beforeEach(commonSetup)

	test('should handle keyboard navigation', async ({page}) => {
		const exerciseLibrary = new ExerciseLibrary(page)
		const exercisePage = new ExercisePage(page)

		await exerciseLibrary.startFirstExercise()

		// Input should be auto-focused
		await exercisePage.expectInputFocused()

		// Should be able to type and submit with Enter
		await page.keyboard.type(EXERCISE_DATA.verbsBe.correctAnswers[0])
		await page.keyboard.press('Enter')

		await exercisePage.expectCorrectFeedback()
	})

	test('should show progress indicator', async ({page}) => {
		const exerciseLibrary = new ExerciseLibrary(page)
		const exercisePage = new ExercisePage(page)

		await exerciseLibrary.startFirstExercise()

		// Should start at question 1
		await exercisePage.expectProgressText(UI_TEXT.progress.createPattern(1))

		// Answer and check progress updates
		await exercisePage.submitAnswer(EXERCISE_DATA.verbsBe.correctAnswers[0])
		await exercisePage.waitForAutoAdvance()

		await exercisePage.expectProgressText(UI_TEXT.progress.createPattern(2))
	})
})

test.describe('Word Form Exercise - Alternative Exercises', () => {
	test.beforeEach(commonSetup)

	test('should handle alternative exercise (verbs-have)', async ({page}) => {
		const exerciseLibrary = new ExerciseLibrary(page)
		const exercisePage = new ExercisePage(page)

		await exerciseLibrary.startSecondExercise()

		await expect(page).toHaveURL(ROUTES.exerciseVerbsHave)
		await exercisePage.expectPageLoaded()

		// Answer first question
		await exercisePage.submitAnswer(EXERCISE_DATA.verbsHave.correctAnswers[0])
		await exercisePage.expectCorrectFeedback()
		await exercisePage.waitForAutoAdvance()

		await exercisePage.expectProgressText(UI_TEXT.progress.createPattern(2))
	})

	test('should handle alternative answers in verbs-have', async ({page}) => {
		const exerciseLibrary = new ExerciseLibrary(page)
		const exercisePage = new ExercisePage(page)

		await exerciseLibrary.startSecondExercise()

		// Answer all questions to reach the final one with alternatives
		const answers = EXERCISE_DATA.verbsHave.correctAnswers.slice(0, -1) // All except last
		await exercisePage.answerSequence(answers)

		// Should be at final question - test alternative answer
		await exercisePage.expectProgressText(UI_TEXT.progress.createPattern(6))
		await exercisePage.submitAnswer(
			EXERCISE_DATA.verbsHave.alternativeAnswers.finalQuestion[1]
		)

		await exercisePage.expectCorrectFeedback()
		await exercisePage.expectExerciseCompleted()
	})
})
