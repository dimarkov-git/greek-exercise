import {type Page, test} from '@playwright/test'
import {EXERCISE_DATA, EXERCISE_STATUS, UI_TEXT} from '../fixtures/test-data'
import {ExerciseLibrary} from '../pages/ExerciseLibrary'
import {ExercisePage} from '../pages/ExercisePage'

const commonSetup = async (page: Page) => {
	const exerciseLibrary = new ExerciseLibrary(page)
	const exercisePage = new ExercisePage(page)

	await exerciseLibrary.goto()
	await exerciseLibrary.startFirstExercise()
	await exercisePage.expectPageLoaded()
}

test.describe('Word Form Exercise - Basic Feedback', () => {
	test.beforeEach(commonSetup)

	test('should show correct feedback for right answers', async ({page}) => {
		const exercisePage = new ExercisePage(page)

		await exercisePage.submitAnswer(EXERCISE_DATA.verbsBe.correctAnswers[0])

		await exercisePage.expectCorrectFeedback()
		await exercisePage.expectInputStatus(EXERCISE_STATUS.correctAnswer)
	})

	test('should show incorrect feedback for wrong answers', async ({page}) => {
		const exercisePage = new ExercisePage(page)

		await exercisePage.submitAnswer(EXERCISE_DATA.verbsBe.wrongAnswers[0])

		await exercisePage.expectIncorrectFeedback()
		await exercisePage.expectInputStatus(EXERCISE_STATUS.wrongAnswer)
	})

	test('should require correction after wrong answer', async ({page}) => {
		const exercisePage = new ExercisePage(page)

		// Answer incorrectly
		await exercisePage.submitAnswer(EXERCISE_DATA.verbsBe.wrongAnswers[0])
		await exercisePage.waitForAnswerProcessing()

		// Should transition to require correction state
		await exercisePage.expectInputStatus(EXERCISE_STATUS.requireCorrection)

		// Try wrong answer again - should still require correction
		await exercisePage.submitAnswer(EXERCISE_DATA.verbsBe.wrongAnswers[1])
		await exercisePage.expectInputStatus(EXERCISE_STATUS.requireCorrection)

		// Enter correct answer - should now accept
		await exercisePage.submitAnswer(EXERCISE_DATA.verbsBe.correctAnswers[0])
		await exercisePage.expectCorrectFeedback()
	})
})

test.describe('Word Form Exercise - Error Correction Flow', () => {
	test.beforeEach(commonSetup)

	test('should handle error correction flow in verbs-have exercise', async ({
		page
	}) => {
		const exerciseLibrary = new ExerciseLibrary(page)
		const exercisePage = new ExercisePage(page)

		// Switch to verbs-have exercise
		await page.goto('/exercises')
		await exerciseLibrary.startSecondExercise()

		// Answer incorrectly
		await exercisePage.submitAnswer(EXERCISE_DATA.verbsHave.wrongAnswers[0])
		await exercisePage.waitForAnswerProcessing()

		// Should show error and require correction
		await exercisePage.expectIncorrectFeedback()

		// Wait for transition to correction state
		await expect(exercisePage.input).toHaveAttribute(
			'data-status',
			EXERCISE_STATUS.requireCorrection
		)

		// Enter correct answer
		await exercisePage.submitAnswer(EXERCISE_DATA.verbsHave.correctAnswers[0])
		await exercisePage.waitForAnswerProcessing()

		// Should advance to next question
		await exercisePage.waitForAutoAdvance()
		await exercisePage.expectProgressText(UI_TEXT.progress.createPattern(2))
		await exercisePage.expectInputFocused()
	})
})

test.describe('Word Form Exercise - Input Validation', () => {
	test.beforeEach(commonSetup)

	test('should handle special characters gracefully', async ({page}) => {
		const exercisePage = new ExercisePage(page)

		// Enter text with special characters and emojis
		await exercisePage.submitAnswer('ÎµÎ¯Î¼Î±Î¹!@#$%^&*()ðŸ˜€')

		// Should handle gracefully (likely show as incorrect)
		await exercisePage.waitForAnswerProcessing()
		await exercisePage.expectInputStatus(EXERCISE_STATUS.wrongAnswer)
	})

	test('should handle very long input', async ({page}) => {
		const exercisePage = new ExercisePage(page)

		// Enter very long text
		const longText = 'Î±'.repeat(1000)
		await exercisePage.submitAnswer(longText)

		// Should handle without crashing
		await exercisePage.waitForAnswerProcessing()
		await exercisePage.expectInputStatus(EXERCISE_STATUS.wrongAnswer)
	})

	test('should handle empty input gracefully', async ({page}) => {
		const exercisePage = new ExercisePage(page)

		// Try to submit empty input
		await exercisePage.fillInput('')
		await exercisePage.clickSubmitButton()

		// Submit button should be disabled for empty input
		// or if enabled, should handle gracefully
		await expect(exercisePage.submitButton).toBeDisabled()
	})
})

test.describe('Word Form Exercise - UI/UX Behavior', () => {
	test.beforeEach(commonSetup)

	test('should show loading state during answer checking', async ({page}) => {
		const exercisePage = new ExercisePage(page)

		await exercisePage.submitAnswer(EXERCISE_DATA.verbsBe.correctAnswers[0])

		// Briefly check for loading state (might be very fast)
		await exercisePage.expectInputStatus(EXERCISE_STATUS.checking)
	})

	test('should handle rapid consecutive submissions', async ({page}) => {
		const exercisePage = new ExercisePage(page)

		// Rapidly submit multiple answers
		for (let i = 0; i < 3; i++) {
			await exercisePage.fillInput(EXERCISE_DATA.verbsBe.wrongAnswers[0])
			await page.keyboard.press('Enter')
			// Allow UI to process submission
			await expect(exercisePage.input).toHaveAttribute(
				'data-status',
				EXERCISE_STATUS.wrongAnswer,
				{timeout: 1000}
			)
		}

		// Should handle gracefully without breaking
		await exercisePage.waitForAnswerProcessing()
		await exercisePage.expectIncorrectFeedback()
	})

	test('should maintain input focus during error states', async ({page}) => {
		const exercisePage = new ExercisePage(page)

		// Answer incorrectly
		await exercisePage.submitAnswer(EXERCISE_DATA.verbsBe.wrongAnswers[0])
		await exercisePage.waitForAnswerProcessing()

		// Input should remain focused for correction
		await exercisePage.expectInputFocused()

		// After correction, should also maintain focus
		await exercisePage.submitAnswer(EXERCISE_DATA.verbsBe.correctAnswers[0])
		await exercisePage.waitForAutoAdvance()

		await exercisePage.expectInputFocused()
	})
})
